{% comment %}
  Main Product Section - Theme 2.0
  Supports App blocks (e.g. Appstle Bundles / Appstle Subscriptions).
  Add the Appstle block in Customize → Product page → Main product → Add block.
{% endcomment %}

<div class="product-page" data-product-id="{{ product.id }}">
  <div class="product-container">
    <div class="product-main">
      <div class="product-gallery">
        {% render 'product-gallery', product: product %}
      </div>

      <div class="product-info">
        <div class="product-trust-badge">
          <p>Subscribe & save 15% + unlock more savings with bundles</p>
        </div>

        {% comment %} Bundles / Combos: cajitas con productos tag "combo" — justo debajo del mensaje de bundles {% endcomment %}
        {% assign combos_collection = section.settings.combo_bundles_collection %}
        {% if combos_collection == blank %}
          {% assign combos_collection = collections['combos'] %}
        {% endif %}
        {% if combos_collection == blank %}
          {% assign combos_collection = collections['bundles'] %}
        {% endif %}
        {% if combos_collection == blank %}
          {% assign combos_collection = collections['all'] %}
        {% endif %}
        {% if combos_collection != blank and combos_collection.products.size > 0 %}
          {% render 'product-combos-block', collection: combos_collection %}
        {% endif %}

        {% if product.metafields.reviews.rating %}
          <div class="product-reviews-summary">
            <div class="star-rating" data-rating="{{ product.metafields.reviews.rating }}">
              {% assign rating = product.metafields.reviews.rating | times: 1.0 %}
              {% for i in (1..5) %}
                {% if i <= rating %}<span class="star filled">★</span>{% else %}<span class="star">★</span>{% endif %}
              {% endfor %}
            </div>
            <span class="reviews-count">({{ product.metafields.reviews.count | default: 0 }} reviews)</span>
          </div>
        {% endif %}

        <h1 class="product-title">{{ product.title }}</h1>

        {% assign variant_title = product.selected_or_first_available_variant.title %}
        {% if variant_title != product.title and variant_title != 'Default Title' %}
          <p class="variant-description" id="variant-description">{{ variant_title }}</p>
        {% endif %}

        {% render 'product-price', product: product %}

        <div class="stock-status" id="stock-status">
          {% if product.selected_or_first_available_variant.available %}
            <span class="in-stock">In Stock</span>
          {% else %}
            <span class="out-of-stock">Sold Out</span>
          {% endif %}
        </div>

        <form action="/cart/add" method="post" enctype="multipart/form-data" id="product-form">
          <input type="hidden" name="id" id="product-variant-id" value="{{ product.selected_or_first_available_variant.id }}">

          {% if product.options_with_values.size > 0 %}
            {% for option in product.options_with_values %}
              {% assign should_show_option = true %}
              {% if option.name == 'Title' or option.name == 'title' or option.name == 'TITLE' %}
                {% assign has_non_default = false %}
                {% for value in option.values %}
                  {% unless value == 'Default Title' or value == 'default title' or value == 'DEFAULT TITLE' %}
                    {% assign has_non_default = true %}
                    {% break %}
                  {% endunless %}
                {% endfor %}
                {% unless has_non_default %}{% assign should_show_option = false %}{% endunless %}
              {% endif %}

              {% if should_show_option %}
                {% if option.name == 'Flavor' or option.name == 'flavor' or option.name == 'Option1' %}
                  {% render 'variant-selector-flavor', option: option, product: product %}
                {% elsif option.name == 'Size' or option.name == 'size' or option.name == 'Option2' %}
                  {% render 'variant-selector-size', option: option, product: product %}
                {% else %}
                  {% unless option.name == 'Title' or option.name == 'title' or option.name == 'TITLE' %}
                    {% render 'variant-selector-default', option: option, product: product %}
                  {% endunless %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}

          {% comment %} Purchase options: Subscribe & Save vs One time – inyectado por app (Appstle/Seal). {% endcomment %}
          <div class="product-purchase-options" id="product-purchase-options">
            <div id="appstle-subscription-widget" class="product-app-blocks" aria-label="Subscription options"></div>
            <div class="product-app-blocks">
              {% for block in section.blocks %}
                {% if block.type == '@app' %}
                  <div class="product-app-block" {{ block.shopify_attributes }}>
                    {% render block %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
            <div class="product-subscriber-benefits" id="product-subscriber-benefits">
              <p class="product-subscriber-benefits-title">Subscriber benefits:</p>
              <ul class="product-subscriber-benefits-list">
                <li>VIP exclusive perks and early access</li>
                <li>Always save 15%</li>
                <li>Flexible delivery: Adjust, skip, cancel anytime</li>
              </ul>
              <a href="#faq" class="product-frequency-link">Which frequency is right for me?</a>
            </div>
          </div>

          <div class="quantity-selector">
            <label for="quantity">Quantity:</label>
            <div class="quantity-controls">
              <button type="button" class="qty-btn qty-minus" aria-label="Decrease quantity">−</button>
              <input type="number" id="quantity" name="quantity" value="1" min="1" class="qty-input">
              <button type="button" class="qty-btn qty-plus" aria-label="Increase quantity">+</button>
            </div>
          </div>

          {% render 'add-to-cart-button', product: product %}
        </form>

        <a href="#faq" class="help-link">Is this right for me?</a>

        <div class="product-accordions">
          {% if product.metafields.custom.ingredients %}
            <details class="accordion">
              <summary>Ingredients</summary>
              <div class="accordion-content">{{ product.metafields.custom.ingredients }}</div>
            </details>
          {% endif %}
          {% if product.metafields.custom.directions %}
            <details class="accordion">
              <summary>Directions</summary>
              <div class="accordion-content">{{ product.metafields.custom.directions }}</div>
            </details>
          {% endif %}
        </div>
      </div>
    </div>

    {% comment %}
      Product subsections (FAQ, benefits, etc.) must be added in the product template
      (Theme Editor → Product page), not here. Shopify does not allow {% section %} inside a section.
    {% endcomment %}
    <div class="product-sections" id="product-sections">
      {% comment %} Optional: render FAQ and other content via snippets if you create them. {% endcomment %}
    </div>
  </div>
</div>

<script type="application/json" id="product-variants-json">
{
  "product": {
    "id": {{ product.id }},
    "first_image": {{ product.featured_image | image_url: width: 2000 | json }},
    "variants": [
      {% for variant in product.variants %}
      {"id":{{ variant.id }},"title":{{ variant.title | json }},"price":{{ variant.price }},"compare_at_price":{{ variant.compare_at_price | default: 0 }},"available":{{ variant.available | json }},"option1":{{ variant.option1 | json }},"option2":{{ variant.option2 | json }},"option3":{{ variant.option3 | json }},"image":{{ variant.image | default: product.featured_image | image_url: width: 2000 | json }},"sku":{{ variant.sku | json }}}{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    "options": [
      {% for option in product.options_with_values %}
      {"name":{{ option.name | json }},"values":{{ option.values | json }}}{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
}
</script>

{{ 'product-page.js' | asset_url | script_tag }}

{% schema %}
{
  "name": "Product information",
  "tag": "section",
  "class": "section-main-product",
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "settings": [
    {
      "type": "collection",
      "id": "combo_bundles_collection",
      "label": "Combos / Bundles collection",
      "info": "Collection of products with tag \"combo\" (bundles). Create an automatic collection with condition: Product tag equals combo. If empty, theme tries collections \"combos\" or \"bundles\"."
    }
  ]
}
{% endschema %}
