{% comment %}
  Main Product Section - Theme 2.0
  Supports App blocks (e.g. Appstle Bundles / Appstle Subscriptions).
  Add the Appstle block in Customize → Product page → Main product → Add block.
{% endcomment %}

<div class="product-page" data-product-id="{{ product.id }}">
  <div class="product-container">
    <div class="product-main">
      <div class="product-gallery">
        {% render 'product-gallery', product: product %}
      </div>

      <div class="product-info">
        <div class="product-trust-badge">
          <p>Bundle and save 15%! Unlock more savings with subscriptions</p>
        </div>

        {% if product.metafields.reviews.rating %}
          <div class="product-reviews-summary">
            <div class="star-rating" data-rating="{{ product.metafields.reviews.rating }}">
              {% assign rating = product.metafields.reviews.rating | times: 1.0 %}
              {% for i in (1..5) %}
                {% if i <= rating %}<span class="star filled">★</span>{% else %}<span class="star">★</span>{% endif %}
              {% endfor %}
            </div>
            <span class="reviews-count">({{ product.metafields.reviews.count | default: 0 }} reviews)</span>
          </div>
        {% endif %}

        <h1 class="product-title">{{ product.title }}</h1>

        {% assign variant_title = product.selected_or_first_available_variant.title %}
        {% if variant_title != product.title and variant_title != 'Default Title' %}
          <p class="variant-description" id="variant-description">{{ variant_title }}</p>
        {% endif %}

        {% if product.description != blank %}
          <div class="product-description">
            {{ product.description }}
          </div>
        {% endif %}

        {% render 'product-price', product: product %}

        <div class="stock-status" id="stock-status">
          {% if product.selected_or_first_available_variant.available %}
            <span class="in-stock">In Stock</span>
          {% else %}
            <span class="out-of-stock">Sold Out</span>
          {% endif %}
        </div>

        {% comment %} Combos / Bundles: cajitas con productos tag "combo" — debajo de stock-status {% endcomment %}
        {% assign combos_collection = section.settings.combo_bundles_collection %}
        {% if combos_collection == blank %}
          {% assign combos_collection = collections['combos'] %}
        {% endif %}
        {% if combos_collection == blank %}
          {% assign combos_collection = collections['bundles'] %}
        {% endif %}
        {% if combos_collection == blank %}
          {% assign combos_collection = collections['all'] %}
        {% endif %}
        {% comment %} No mostrar combos/bundles si el producto tiene tag mastercase {% endcomment %}
        {% unless product.tags contains 'mastercase' %}
          {% if combos_collection != blank and combos_collection.products.size > 0 %}
            {% render 'product-combos-block', collection: combos_collection %}
          {% endif %}
        {% endunless %}

        <form action="/cart/add" method="post" enctype="multipart/form-data" id="product-form">
          <input type="hidden" name="id" id="product-variant-id" value="{{ product.selected_or_first_available_variant.id }}">

          {% if product.options_with_values.size > 0 %}
            {% for option in product.options_with_values %}
              {% assign should_show_option = true %}
              {% if option.name == 'Title' or option.name == 'title' or option.name == 'TITLE' %}
                {% assign has_non_default = false %}
                {% for value in option.values %}
                  {% unless value == 'Default Title' or value == 'default title' or value == 'DEFAULT TITLE' %}
                    {% assign has_non_default = true %}
                    {% break %}
                  {% endunless %}
                {% endfor %}
                {% unless has_non_default %}{% assign should_show_option = false %}{% endunless %}
              {% endif %}

              {% if should_show_option %}
                {% if option.name == 'Flavor' or option.name == 'flavor' or option.name == 'Option1' %}
                  {% render 'variant-selector-flavor', option: option, product: product %}
                {% elsif option.name == 'Size' or option.name == 'size' or option.name == 'Option2' %}
                  {% render 'variant-selector-size', option: option, product: product %}
                {% else %}
                  {% unless option.name == 'Title' or option.name == 'title' or option.name == 'TITLE' %}
                    {% render 'variant-selector-default', option: option, product: product %}
                  {% endunless %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}

          {% comment %} Purchase options: Subscribe & Save vs One time – inyectado por app (Appstle/Seal). {% endcomment %}
          <div class="product-purchase-options" id="product-purchase-options">
            <div id="appstle-subscription-widget" class="product-app-blocks" aria-label="Subscription options"></div>
            <div class="product-app-blocks">
              {% for block in section.blocks %}
                {% if block.type == '@app' %}
                  <div class="product-app-block" {{ block.shopify_attributes }}>
                    {% render block %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
            <div class="product-subscriber-benefits" id="product-subscriber-benefits">
              {% if product.tags contains 'mastercase' %}
                <p class="product-subscriber-benefits-title">Retail and benefits:</p>
                <ul class="product-subscriber-benefits-list">
                  <li>Wholesale partner pricing</li>
                  <li>Bulk order discounts</li>
                  <li>Dedicated partner support</li>
                </ul>
              {% else %}
                <p class="product-subscriber-benefits-title">Subscriber benefits:</p>
                <ul class="product-subscriber-benefits-list">
                  <li>VIP exclusive perks and early access</li>
                  <li>Save 20%</li>
                  <li>Flexible delivery: Adjust, skip, cancel anytime</li>
                  <li>Free shipping on orders over $75</li>
                </ul>
              {% endif %}
            </div>
          </div>

          <div class="quantity-selector">
            <label for="quantity">Quantity:</label>
            <div class="quantity-controls">
              <button type="button" class="qty-btn qty-minus" aria-label="Decrease quantity">−</button>
              <input type="number" id="quantity" name="quantity" value="1" min="1" step="1" class="qty-input">
              <button type="button" class="qty-btn qty-plus" aria-label="Increase quantity">+</button>
            </div>
          </div>

          {% render 'add-to-cart-button', product: product %}
        </form>

        <a href="#faq" class="help-link">Is this right for me?</a>

        <div class="product-accordions">
          {% if product.metafields.custom.ingredients %}
            <details class="accordion">
              <summary>Ingredients</summary>
              <div class="accordion-content">{{ product.metafields.custom.ingredients }}</div>
            </details>
          {% endif %}
          {% if product.metafields.custom.directions %}
            <details class="accordion">
              <summary>Directions</summary>
              <div class="accordion-content">{{ product.metafields.custom.directions }}</div>
            </details>
          {% endif %}
        </div>
      </div>
    </div>

    {% comment %} Unit products: sección aparte debajo de todo (mismo listado que página de inicio) {% endcomment %}
    {% assign products_collection = collections.all %}
    {% if collections.featured and collections.featured.products.size > 0 %}
      {% assign products_collection = collections.featured %}
    {% endif %}
    {% assign unit_count = 0 %}
    {% for rec_product in products_collection.products %}
      {% if rec_product.tags contains 'unit' and rec_product.id != product.id %}
        {% unless rec_product.handle == 'master-case' or rec_product.tags contains 'wholesale' or rec_product.tags contains 'master-case' %}
          {% assign unit_count = unit_count | plus: 1 %}
        {% endunless %}
      {% endif %}
    {% endfor %}
    {% if unit_count > 0 %}
    <section class="product-page-unit-section" aria-label="You may also like">
      <div class="container">
        <div class="product-page-unit-section-header">
          <h2 class="section-title">You may also like</h2>
        </div>
        <div class="product-unit-carousel-wrap">
          <button type="button" class="product-unit-carousel-btn product-unit-carousel-prev" aria-label="Previous products">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
          </button>
          <button type="button" class="product-unit-carousel-btn product-unit-carousel-next" aria-label="Next products">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
          </button>
          <div class="product-unit-carousel" id="product-unit-carousel">
            <div class="product-unit-recommendations-grid" role="list">
          {% assign unit_shown = 0 %}
          {% for rec_product in products_collection.products %}
            {% if rec_product.tags contains 'unit' and rec_product.id != product.id %}
              {% unless rec_product.handle == 'master-case' or rec_product.tags contains 'wholesale' or rec_product.tags contains 'master-case' %}
                {% assign unit_shown = unit_shown | plus: 1 %}
                <div class="product-card product-unit-card">
                  <a href="{{ rec_product.url }}" class="product-card-link">
                    <div class="product-image-wrapper">
                      {% if rec_product.featured_image %}
                        <img src="{{ rec_product.featured_image | image_url: width: 800 }}" alt="{{ rec_product.featured_image.alt | default: rec_product.title | escape }}" class="product-image" loading="lazy" width="400" height="400">
                      {% else %}
                        <div class="product-image-placeholder"><span>No Image</span></div>
                      {% endif %}
                      {% if rec_product.compare_at_price > rec_product.price %}
                        <span class="product-sale-badge">Sale</span>
                      {% endif %}
                    </div>
                    <div class="product-content">
                      <div class="product-content-top">
                        {% if rec_product.tags contains 'most-popular' or rec_product.tags contains 'popular' %}
                          <span class="product-badge">Popular</span>
                        {% elsif rec_product.tags contains 'sensitive' or rec_product.tags contains 'sensitive-skin' %}
                          <span class="product-badge">Sensitive</span>
                        {% elsif rec_product.tags contains 'new' %}
                          <span class="product-badge">New</span>
                        {% endif %}
                        <h3 class="product-name">{{ rec_product.title }}</h3>
                      </div>
                      <div class="product-content-bottom">
                        <span class="product-price">{{ rec_product.price | money }}</span>
                        {% if rec_product.compare_at_price > rec_product.price %}
                          <span class="product-compare-price">{{ rec_product.compare_at_price | money }}</span>
                        {% endif %}
                        {% if rec_product.variants.size > 1 %}
                          <span class="product-variants-count">{{ rec_product.variants.size }} options</span>
                        {% endif %}
                      </div>
                    </div>
                  </a>
                  <a href="{{ rec_product.url }}" class="product-cta">Shop Now</a>
                </div>
              {% endunless %}
            {% endif %}
          {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </section>
    {% endif %}

    {% comment %}
      Product subsections (FAQ, benefits, etc.) must be added in the product template
      (Theme Editor → Product page), not here. Shopify does not allow {% section %} inside a section.
    {% endcomment %}
    <div class="product-sections" id="product-sections">
      {% comment %} Optional: render FAQ and other content via snippets if you create them. {% endcomment %}
    </div>
  </div>
</div>

<script type="application/json" id="product-variants-json">
{
  "product": {
    "id": {{ product.id }},
    "first_image": {{ product.featured_image | image_url: width: 2000 | json }},
    "variants": [
      {% for variant in product.variants %}
      {"id":{{ variant.id }},"title":{{ variant.title | json }},"price":{{ variant.price }},"compare_at_price":{{ variant.compare_at_price | default: 0 }},"available":{{ variant.available | json }},"option1":{{ variant.option1 | json }},"option2":{{ variant.option2 | json }},"option3":{{ variant.option3 | json }},"image":{{ variant.image | default: product.featured_image | image_url: width: 2000 | json }},"sku":{{ variant.sku | json }}}{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    "options": [
      {% for option in product.options_with_values %}
      {"name":{{ option.name | json }},"values":{{ option.values | json }}}{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
}
</script>

{{ 'product-page.js' | asset_url | script_tag }}

<style>
/* Descripción del producto en product-info */
.product-info .product-description {
    font-size: 15px;
    line-height: 1.65;
    color: var(--text-gray, #555);
    margin: 0 0 20px;
}
.product-info .product-description p { margin: 0 0 10px; }
.product-info .product-description p:last-child { margin-bottom: 0; }
.product-info .product-description ul,
.product-info .product-description ol { margin: 0 0 10px; padding-left: 20px; }
.product-info .product-description li { margin-bottom: 4px; }

/* Sección "You may also like" a todo el ancho */
.product-page-unit-section { padding: clamp(50px, 8vw, 80px) 0; background: #f9f9f9; margin-top: 0; width: 100%; }
.product-page-unit-section .container { max-width: none; width: 100%; padding-left: clamp(20px, 4vw, 60px); padding-right: clamp(20px, 4vw, 60px); }
.product-page-unit-section-header { text-align: center; margin-bottom: 2.5rem; }
.product-page-unit-section .section-eyebrow { display: block; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--primary-pink); margin-bottom: 0.5rem; }
.product-page-unit-section .section-title { font-size: clamp(1.75rem, 4vw, 2.5rem); font-weight: 700; margin: 0; font-family: 'Montserrat', sans-serif; color: var(--text-dark); }
/* Carrusel "You may also like" a todo el ancho del contenedor */
.product-page-unit-carousel-wrap { position: relative; margin: 0 calc(-1 * clamp(20px, 4vw, 60px)); padding: 0 clamp(20px, 4vw, 60px); }
.product-page-unit-carousel { overflow: hidden; }
.product-page-unit-section .product-unit-recommendations-grid {
  display: flex;
  gap: 24px;
  overflow-x: auto;
  overflow-y: hidden;
  scroll-snap-type: x mandatory;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  -ms-overflow-style: none;
  padding: 4px 0 16px;
}
.product-page-unit-section .product-unit-recommendations-grid::-webkit-scrollbar { display: none; }
.product-page-unit-section .product-unit-card {
  flex: 0 0 min(280px, 85vw);
  min-width: 0;
  scroll-snap-align: start;
  scroll-snap-stop: always;
}
.product-unit-carousel-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 3;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  background: #fff;
  color: var(--text-dark);
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s, box-shadow 0.2s, opacity 0.2s;
}
.product-unit-carousel-btn:hover { background: #f5f5f5; box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
.product-unit-carousel-btn:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }
.product-unit-carousel-prev { left: 0; }
.product-unit-carousel-next { right: 0; }
.product-page-unit-section .product-card { margin-top: 0; }
/* Sin translateY en hover para no perder espacio arriba en el carrusel */
.product-page-unit-section .product-card:hover { transform: none; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
.product-page-unit-section .product-card-link { text-decoration: none; color: inherit; display: flex; flex-direction: column; flex: 1; }
.product-page-unit-section .product-image-wrapper { position: relative; width: 100%; height: 300px; overflow: hidden; background: var(--light-gray); }
.product-page-unit-section .product-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
.product-page-unit-section .product-card:hover .product-image { transform: scale(1.05); }
.product-page-unit-section .product-image-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--light-gray); color: var(--text-gray); font-size: 14px; }
.product-page-unit-section .product-sale-badge { position: absolute; top: 12px; right: 12px; background: var(--accent-red, #c00); color: white; padding: 6px 12px; border-radius: 999px; font-size: 12px; font-weight: 700; text-transform: uppercase; z-index: 2; }
/* Contenido compacto de la tarjeta */
.product-page-unit-section .product-content {
  padding: 14px 16px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  flex: 1;
  min-height: 0;
}
.product-page-unit-section .product-content-top {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.product-page-unit-section .product-content .product-badge {
  padding: 4px 10px;
  font-size: 9px;
  letter-spacing: 0.04em;
  margin-bottom: 0;
  align-self: flex-start;
}
.product-page-unit-section .product-content .product-name {
  font-size: 1rem;
  font-weight: 600;
  margin: 0;
  line-height: 1.3;
  color: var(--text-dark);
}
.product-page-unit-section .product-content-bottom {
  display: flex;
  align-items: baseline;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: auto;
  padding-top: 10px;
  border-top: 1px solid rgba(0,0,0,0.06);
}
.product-page-unit-section .product-content .product-price {
  font-size: 1.125rem;
  font-weight: 700;
  color: var(--primary-pink);
}
.product-page-unit-section .product-compare-price {
  font-size: 0.875rem;
  color: var(--text-gray);
  text-decoration: line-through;
}
.product-page-unit-section .product-variants-count {
  font-size: 0.75rem;
  color: var(--text-gray);
  margin: 0;
  padding: 2px 8px;
  background: rgba(0,0,0,0.05);
  border-radius: 999px;
  font-weight: 500;
}
/* Ocultar contenido inyectado por apps (Selling Plans / suscripciones) en las tarjetas del carrusel */
.product-page-unit-section .product-content [class*="selling-plan"],
.product-page-unit-section .product-content .selling-plan-select,
.product-page-unit-section .product-content [id*="selling-plan"] { display: none !important; }
@media (max-width: 768px) {
  .product-page-unit-section .product-image-wrapper { height: 280px; }
  .product-page-unit-section .product-content { padding: 12px 14px 14px; }
  .product-unit-carousel-btn { width: 38px; height: 38px; }
  .product-unit-carousel-prev { left: 8px; }
  .product-unit-carousel-next { right: 8px; }
}
</style>

<script>
(function() {
  var wrap = document.querySelector('.product-unit-carousel-wrap');
  if (!wrap) return;
  var track = wrap.querySelector('.product-unit-recommendations-grid');
  var prevBtn = wrap.querySelector('.product-unit-carousel-prev');
  var nextBtn = wrap.querySelector('.product-unit-carousel-next');
  if (!track || !prevBtn || !nextBtn) return;

  function getStep() {
    var card = track.querySelector('.product-unit-card');
    return card ? card.offsetWidth + 24 : 304;
  }
  function updateButtons() {
    var maxScroll = track.scrollWidth - track.clientWidth;
    prevBtn.disabled = track.scrollLeft <= 2;
    nextBtn.disabled = track.scrollLeft >= maxScroll - 2;
  }
  prevBtn.addEventListener('click', function() {
    track.scrollBy({ left: -getStep(), behavior: 'smooth' });
  });
  nextBtn.addEventListener('click', function() {
    track.scrollBy({ left: getStep(), behavior: 'smooth' });
  });
  track.addEventListener('scroll', function() { setTimeout(updateButtons, 100); });
  window.addEventListener('resize', updateButtons);
  updateButtons();
})();
</script>

{% schema %}
{
  "name": "Product information",
  "tag": "section",
  "class": "section-main-product",
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "settings": [
    {
      "type": "collection",
      "id": "combo_bundles_collection",
      "label": "Combos / Bundles collection",
      "info": "Collection of products with tag \"combo\" (bundles). Create an automatic collection with condition: Product tag equals combo. If empty, theme tries collections \"combos\" or \"bundles\"."
    }
  ]
}
{% endschema %}
