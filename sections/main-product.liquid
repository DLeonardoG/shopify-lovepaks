{% comment %}
  Main Product Section - Theme 2.0
  Supports App blocks (e.g. Appstle Bundles / Appstle Subscriptions).
  Add the Appstle block in Customize → Product page → Main product → Add block.
{% endcomment %}

<div class="product-page" data-product-id="{{ product.id }}">
  <div class="product-container">
    <div class="product-main">
      <div class="product-gallery">
        {% render 'product-gallery', product: product %}
      </div>

      <div class="product-info">
        <div class="product-trust-badge">
          <p>Subscribe & save 15% + unlock more savings with bundles</p>
        </div>

        {% if product.metafields.reviews.rating %}
          <div class="product-reviews-summary">
            <div class="star-rating" data-rating="{{ product.metafields.reviews.rating }}">
              {% assign rating = product.metafields.reviews.rating | times: 1.0 %}
              {% for i in (1..5) %}
                {% if i <= rating %}<span class="star filled">★</span>{% else %}<span class="star">★</span>{% endif %}
              {% endfor %}
            </div>
            <span class="reviews-count">({{ product.metafields.reviews.count | default: 0 }} reviews)</span>
          </div>
        {% endif %}

        <h1 class="product-title">{{ product.title }}</h1>

        {% assign variant_title = product.selected_or_first_available_variant.title %}
        {% if variant_title != product.title and variant_title != 'Default Title' %}
          <p class="variant-description" id="variant-description">{{ variant_title }}</p>
        {% endif %}

        {% render 'product-price', product: product %}

        <div class="stock-status" id="stock-status">
          {% if product.selected_or_first_available_variant.available %}
            <span class="in-stock">In Stock</span>
          {% else %}
            <span class="out-of-stock">Sold Out</span>
          {% endif %}
        </div>

        {% comment %} Combos / Bundles: cajitas con productos tag "combo" — debajo de stock-status {% endcomment %}
        {% assign combos_collection = section.settings.combo_bundles_collection %}
        {% if combos_collection == blank %}
          {% assign combos_collection = collections['combos'] %}
        {% endif %}
        {% if combos_collection == blank %}
          {% assign combos_collection = collections['bundles'] %}
        {% endif %}
        {% if combos_collection == blank %}
          {% assign combos_collection = collections['all'] %}
        {% endif %}
        {% comment %} No mostrar combos/bundles si el producto tiene tag mastercase {% endcomment %}
        {% unless product.tags contains 'mastercase' %}
          {% if combos_collection != blank and combos_collection.products.size > 0 %}
            {% render 'product-combos-block', collection: combos_collection %}
          {% endif %}
        {% endunless %}

        <form action="/cart/add" method="post" enctype="multipart/form-data" id="product-form">
          <input type="hidden" name="id" id="product-variant-id" value="{{ product.selected_or_first_available_variant.id }}">

          {% if product.options_with_values.size > 0 %}
            {% for option in product.options_with_values %}
              {% assign should_show_option = true %}
              {% if option.name == 'Title' or option.name == 'title' or option.name == 'TITLE' %}
                {% assign has_non_default = false %}
                {% for value in option.values %}
                  {% unless value == 'Default Title' or value == 'default title' or value == 'DEFAULT TITLE' %}
                    {% assign has_non_default = true %}
                    {% break %}
                  {% endunless %}
                {% endfor %}
                {% unless has_non_default %}{% assign should_show_option = false %}{% endunless %}
              {% endif %}

              {% if should_show_option %}
                {% if option.name == 'Flavor' or option.name == 'flavor' or option.name == 'Option1' %}
                  {% render 'variant-selector-flavor', option: option, product: product %}
                {% elsif option.name == 'Size' or option.name == 'size' or option.name == 'Option2' %}
                  {% render 'variant-selector-size', option: option, product: product %}
                {% else %}
                  {% unless option.name == 'Title' or option.name == 'title' or option.name == 'TITLE' %}
                    {% render 'variant-selector-default', option: option, product: product %}
                  {% endunless %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}

          {% comment %} Purchase options: Subscribe & Save vs One time – inyectado por app (Appstle/Seal). {% endcomment %}
          <div class="product-purchase-options" id="product-purchase-options">
            <div id="appstle-subscription-widget" class="product-app-blocks" aria-label="Subscription options"></div>
            <div class="product-app-blocks">
              {% for block in section.blocks %}
                {% if block.type == '@app' %}
                  <div class="product-app-block" {{ block.shopify_attributes }}>
                    {% render block %}
                  </div>
                {% endif %}
              {% endfor %}
            </div>
            <div class="product-subscriber-benefits" id="product-subscriber-benefits">
              {% if product.tags contains 'mastercase' %}
                <p class="product-subscriber-benefits-title">Retail and benefits:</p>
                <ul class="product-subscriber-benefits-list">
                  <li>Wholesale partner pricing</li>
                  <li>Bulk order discounts</li>
                  <li>Dedicated partner support</li>
                </ul>
              {% else %}
                <p class="product-subscriber-benefits-title">Subscriber benefits:</p>
                <ul class="product-subscriber-benefits-list">
                  <li>VIP exclusive perks and early access</li>
                  <li>Save 15%</li>
                  <li>Flexible delivery: Adjust, skip, cancel anytime</li>
                </ul>
              {% endif %}
            </div>
          </div>

          <div class="quantity-selector">
            <label for="quantity">Quantity:</label>
            <div class="quantity-controls">
              <button type="button" class="qty-btn qty-minus" aria-label="Decrease quantity">−</button>
              <input type="number" id="quantity" name="quantity" value="1" min="1" step="1" class="qty-input">
              <button type="button" class="qty-btn qty-plus" aria-label="Increase quantity">+</button>
            </div>
          </div>

          {% render 'add-to-cart-button', product: product %}
        </form>

        <a href="#faq" class="help-link">Is this right for me?</a>

        <div class="product-accordions">
          {% if product.metafields.custom.ingredients %}
            <details class="accordion">
              <summary>Ingredients</summary>
              <div class="accordion-content">{{ product.metafields.custom.ingredients }}</div>
            </details>
          {% endif %}
          {% if product.metafields.custom.directions %}
            <details class="accordion">
              <summary>Directions</summary>
              <div class="accordion-content">{{ product.metafields.custom.directions }}</div>
            </details>
          {% endif %}
        </div>
      </div>
    </div>

    {% comment %} Unit products: sección aparte debajo de todo (mismo listado que página de inicio) {% endcomment %}
    {% assign products_collection = collections.all %}
    {% if collections.featured and collections.featured.products.size > 0 %}
      {% assign products_collection = collections.featured %}
    {% endif %}
    {% assign unit_count = 0 %}
    {% for rec_product in products_collection.products %}
      {% if rec_product.tags contains 'unit' and rec_product.id != product.id %}
        {% unless rec_product.handle == 'master-case' or rec_product.tags contains 'wholesale' or rec_product.tags contains 'master-case' %}
          {% assign unit_count = unit_count | plus: 1 %}
        {% endunless %}
      {% endif %}
    {% endfor %}
    {% if unit_count > 0 %}
    <section class="product-page-unit-section" aria-label="You may also like">
      <div class="container">
        <div class="product-page-unit-section-header">
          <h2 class="section-title">You may also like</h2>
        </div>
        <div class="product-unit-recommendations-grid">
          {% assign unit_shown = 0 %}
          {% for rec_product in products_collection.products %}
            {% if rec_product.tags contains 'unit' and rec_product.id != product.id %}
              {% unless rec_product.handle == 'master-case' or rec_product.tags contains 'wholesale' or rec_product.tags contains 'master-case' %}
                {% assign unit_shown = unit_shown | plus: 1 %}
                <div class="product-card product-unit-card">
                  <a href="{{ rec_product.url }}" class="product-card-link">
                    <div class="product-image-wrapper">
                      {% if rec_product.featured_image %}
                        <img src="{{ rec_product.featured_image | image_url: width: 800 }}" alt="{{ rec_product.featured_image.alt | default: rec_product.title | escape }}" class="product-image" loading="lazy" width="400" height="400">
                      {% else %}
                        <div class="product-image-placeholder"><span>No Image</span></div>
                      {% endif %}
                      {% if rec_product.compare_at_price > rec_product.price %}
                        <span class="product-sale-badge">Sale</span>
                      {% endif %}
                    </div>
                    <div class="product-content">
                      {% if rec_product.tags contains 'most-popular' or rec_product.tags contains 'popular' %}
                        <span class="product-badge">Most Popular</span>
                      {% elsif rec_product.tags contains 'sensitive' or rec_product.tags contains 'sensitive-skin' %}
                        <span class="product-badge">Sensitive Skin</span>
                      {% elsif rec_product.tags contains 'new' %}
                        <span class="product-badge">New</span>
                      {% endif %}
                      <h3 class="product-name">{{ rec_product.title }}</h3>
                      <p class="product-description">
                        {% if rec_product.description != blank %}
                          {{ rec_product.description | strip_html | truncatewords: 20 }}
                        {% else %}
                          Premium quality product designed for your wellness.
                        {% endif %}
                      </p>
                      <div class="product-price-wrapper">
                        <span class="product-price">{{ rec_product.price | money }}</span>
                        {% if rec_product.compare_at_price > rec_product.price %}
                          <span class="product-compare-price">{{ rec_product.compare_at_price | money }}</span>
                        {% endif %}
                      </div>
                      {% if rec_product.variants.size > 1 %}
                        <p class="product-variants-count">{{ rec_product.variants.size }} options available</p>
                      {% endif %}
                    </div>
                  </a>
                  <a href="{{ rec_product.url }}" class="product-cta">Shop Now</a>
                </div>
              {% endunless %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

    {% comment %}
      Product subsections (FAQ, benefits, etc.) must be added in the product template
      (Theme Editor → Product page), not here. Shopify does not allow {% section %} inside a section.
    {% endcomment %}
    <div class="product-sections" id="product-sections">
      {% comment %} Optional: render FAQ and other content via snippets if you create them. {% endcomment %}
    </div>
  </div>
</div>

<script type="application/json" id="product-variants-json">
{
  "product": {
    "id": {{ product.id }},
    "first_image": {{ product.featured_image | image_url: width: 2000 | json }},
    "variants": [
      {% for variant in product.variants %}
      {"id":{{ variant.id }},"title":{{ variant.title | json }},"price":{{ variant.price }},"compare_at_price":{{ variant.compare_at_price | default: 0 }},"available":{{ variant.available | json }},"option1":{{ variant.option1 | json }},"option2":{{ variant.option2 | json }},"option3":{{ variant.option3 | json }},"image":{{ variant.image | default: product.featured_image | image_url: width: 2000 | json }},"sku":{{ variant.sku | json }}}{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ],
    "options": [
      {% for option in product.options_with_values %}
      {"name":{{ option.name | json }},"values":{{ option.values | json }}}{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  }
}
</script>

{{ 'product-page.js' | asset_url | script_tag }}

<style>
/* Sección "You may also like" debajo de todo (mismo aspecto que products en inicio) */
.product-page-unit-section { padding: clamp(50px, 8vw, 80px) 0; background: #f9f9f9; margin-top: 0; }
.product-page-unit-section-header { text-align: center; margin-bottom: 2.5rem; }
.product-page-unit-section .section-eyebrow { display: block; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--primary-pink); margin-bottom: 0.5rem; }
.product-page-unit-section .section-title { font-size: clamp(1.75rem, 4vw, 2.5rem); font-weight: 700; margin: 0; font-family: 'Montserrat', sans-serif; color: var(--text-dark); }
.product-page-unit-section .product-unit-recommendations-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
.product-page-unit-section .product-card { margin-top: 0; }
.product-page-unit-section .product-card-link { text-decoration: none; color: inherit; display: flex; flex-direction: column; flex: 1; }
.product-page-unit-section .product-image-wrapper { position: relative; width: 100%; height: 300px; overflow: hidden; background: var(--light-gray); }
.product-page-unit-section .product-image { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
.product-page-unit-section .product-card:hover .product-image { transform: scale(1.05); }
.product-page-unit-section .product-image-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--light-gray); color: var(--text-gray); font-size: 14px; }
.product-page-unit-section .product-sale-badge { position: absolute; top: 12px; right: 12px; background: var(--accent-red, #c00); color: white; padding: 6px 12px; border-radius: 999px; font-size: 12px; font-weight: 700; text-transform: uppercase; z-index: 2; }
.product-page-unit-section .product-compare-price { font-size: 18px; color: var(--text-gray); text-decoration: line-through; }
.product-page-unit-section .product-variants-count { font-size: 12px; color: var(--text-gray); margin: 0; font-style: italic; }
@media (max-width: 768px) {
  .product-page-unit-section .product-unit-recommendations-grid { grid-template-columns: 1fr; }
  .product-page-unit-section .product-image-wrapper { height: 280px; }
}
</style>

{% schema %}
{
  "name": "Product information",
  "tag": "section",
  "class": "section-main-product",
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "settings": [
    {
      "type": "collection",
      "id": "combo_bundles_collection",
      "label": "Combos / Bundles collection",
      "info": "Collection of products with tag \"combo\" (bundles). Create an automatic collection with condition: Product tag equals combo. If empty, theme tries collections \"combos\" or \"bundles\"."
    }
  ]
}
{% endschema %}
