{% comment %}
  Product Page Template
  Based on trycreate.co product page structure
  Handles: Variants, Subscriptions, Cart Drawer, Reviews
  
  This template reads product data directly from Shopify:
  - product.id, product.title, product.description
  - product.images, product.featured_image
  - product.variants (all variants with prices, availability)
  - product.options_with_values (variant options)
  - product.selling_plan_groups (subscriptions)
  - product.metafields (custom data)
{% endcomment %}

{% comment %} Debug: Uncomment to see product data {% endcomment %}
{% comment %}
  Product ID: {{ product.id }}
  Product Title: {{ product.title }}
  Variants Count: {{ product.variants.size }}
  Options Count: {{ product.options_with_values.size }}
  Images Count: {{ product.images.size }}
{% endcomment %}

<div class="product-page" data-product-id="{{ product.id }}">
  <div class="product-container">
    
    <!-- Product Main Section -->
    <div class="product-main">
      
      <!-- Product Gallery (Left) -->
      <div class="product-gallery">
        {% render 'product-gallery', product: product %}
      </div>
      
      <!-- Product Info (Right) -->
      <div class="product-info">
        
        <!-- Trust Badge -->
        <div class="product-trust-badge">
          <p>Subscribe & all orders ship FREE + unlock more savings with bundles</p>
        </div>
        
        <!-- Reviews -->
        {% if product.metafields.reviews.rating %}
          <div class="product-reviews-summary">
            <div class="star-rating" data-rating="{{ product.metafields.reviews.rating }}">
              {% assign rating = product.metafields.reviews.rating | times: 1.0 %}
              {% for i in (1..5) %}
                {% if i <= rating %}
                  <span class="star filled">★</span>
                {% else %}
                  <span class="star">★</span>
                {% endif %}
              {% endfor %}
            </div>
            <span class="reviews-count">
              ({{ product.metafields.reviews.count | default: 0 }} reviews)
            </span>
          </div>
        {% endif %}
        
        <!-- Product Title -->
        <h1 class="product-title">{{ product.title }}</h1>
        
        <!-- Variant Description -->
        {% if product.selected_or_first_available_variant.title != product.title %}
          <p class="variant-description" id="variant-description">
            {{ product.selected_or_first_available_variant.title }}
          </p>
        {% endif %}
        
        <!-- Price Section -->
        {% render 'product-price', product: product %}
        
        <!-- Stock Status -->
        <div class="stock-status" id="stock-status">
          {% if product.selected_or_first_available_variant.available %}
            <span class="in-stock">In Stock</span>
          {% else %}
            <span class="out-of-stock">Sold Out</span>
          {% endif %}
        </div>
        
        <!-- Variant Selectors -->
        <form action="/cart/add" method="post" enctype="multipart/form-data" id="product-form">
          <input type="hidden" name="id" id="product-variant-id" value="{{ product.selected_or_first_available_variant.id }}">
          
          <!-- Flavor Selector -->
          {% if product.options_with_values.size > 0 %}
            {% for option in product.options_with_values %}
              {% if option.name == 'Flavor' or option.name == 'Option1' %}
                {% render 'variant-selector-flavor', option: option, product: product %}
              {% elsif option.name == 'Size' or option.name == 'Option2' %}
                {% render 'variant-selector-size', option: option, product: product %}
              {% else %}
                {% render 'variant-selector-default', option: option, product: product %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          <!-- Subscription Toggle -->
          {% if product.selling_plan_groups.size > 0 %}
            {% render 'subscription-widget', product: product %}
          {% endif %}
          
          <!-- Quantity Selector -->
          <div class="quantity-selector">
            <label for="quantity">Quantity:</label>
            <div class="quantity-controls">
              <button type="button" class="qty-btn qty-minus" aria-label="Decrease quantity">−</button>
              <input type="number" 
                     id="quantity" 
                     name="quantity" 
                     value="1" 
                     min="1" 
                     class="qty-input">
              <button type="button" class="qty-btn qty-plus" aria-label="Increase quantity">+</button>
            </div>
          </div>
          
          <!-- Add to Cart Button -->
          {% render 'add-to-cart-button', product: product %}
          
        </form>
        
        <!-- Help Link -->
        <a href="#faq" class="help-link">Is this right for me?</a>
        
        <!-- Accordion Sections -->
        <div class="product-accordions">
          {% if product.metafields.custom.ingredients %}
            <details class="accordion">
              <summary>Ingredients</summary>
              <div class="accordion-content">
                {{ product.metafields.custom.ingredients }}
              </div>
            </details>
          {% endif %}
          
          {% if product.metafields.custom.directions %}
            <details class="accordion">
              <summary>Directions</summary>
              <div class="accordion-content">
                {{ product.metafields.custom.directions }}
              </div>
            </details>
          {% endif %}
        </div>
        
      </div>
    </div>
    
    <!-- Product Sections Below -->
    <div class="product-sections">
      
      <!-- Frequently Bought Together -->
      {% section 'product-recommendations' %}
      
      <!-- Benefits Section -->
      {% if product.metafields.custom.benefits %}
        {% section 'product-benefits' %}
      {% endif %}
      
      <!-- Science vs Myth -->
      {% if product.metafields.custom.myths %}
        {% section 'product-myths' %}
      {% endif %}
      
      <!-- Experts Section -->
      {% if product.metafields.custom.experts %}
        {% section 'product-experts' %}
      {% endif %}
      
      <!-- Comparison Table -->
      {% if product.metafields.custom.comparison %}
        {% section 'product-comparison' %}
      {% endif %}
      
      <!-- Lifestyle Gallery -->
      {% if product.metafields.custom.lifestyle_images %}
        {% section 'product-lifestyle' %}
      {% endif %}
      
      <!-- FAQ Section -->
      {% section 'product-faq' %}
      
      <!-- Reviews Section -->
      {% section 'product-reviews' %}
      
    </div>
    
  </div>
</div>

<!-- Product Variants Data (for JavaScript) -->
<script type="application/json" id="product-variants-json">
  {
    "product": {
      "id": {{ product.id }},
      "variants": [
        {% for variant in product.variants %}
        {
          "id": {{ variant.id }},
          "title": {{ variant.title | json }},
          "price": {{ variant.price }},
          "compare_at_price": {{ variant.compare_at_price | default: 0 }},
          "available": {{ variant.available | json }},
          "option1": {{ variant.option1 | json }},
          "option2": {{ variant.option2 | json }},
          "option3": {{ variant.option3 | json }},
          "image": {{ variant.image | img_url: '2000x' | json }},
          "sku": {{ variant.sku | json }}
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ],
      "options": [
        {% for option in product.options_with_values %}
        {
          "name": {{ option.name | json }},
          "values": {{ option.values | json }}
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    }
  }
</script>

<!-- Load Product Page JavaScript -->
{{ 'product-page.js' | asset_url | script_tag }}

